<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="stylesheet" href="../https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe.js for payments -->
</head>
<body>
<header class="header">
    <a href="/index.html"><img src="../img/logo2.png" class="logo"></a>
    <nav id="navbar" class="nav-links">
        <div class="dropdown">
            <button class="boton">Shop</button>
            <div class="dropdown-content">
                <a href="/overallHealth.html">Overall Health</a>
                <a href="/exerciseSupplements.html">Exercise Supplements</a>
            </div>
        </div>
        <button class="boton">About Us</button>
        <button class="boton"><a href="/ContactUs.html">Contact</a></button>
        <a href="/shoppingCart.html"><img src="../img/cart.png" class="carrito"></a>
    </nav>
</header>

<main class="container mt-5">
    <h2>Shopping Cart</h2>
    <div id="cart-items" class="mt-4">

    </div>
    <div class="d-flex justify-content-between align-items-center p-2 bg-white mt-4 rounded">
        <h5>Total: <span id="total-amount">$0.00</span></h5>
        <button class="btn btn-warning btn-lg pay-button" type="button">Proceed to Pay</button>
    </div>
</main>

<footer class="footer mt-5">
    <div class="footer-p">
        <p>Contact Us</p>
        <p>Get in touch at (1) 999-999-9999 or reach out to us on social media for support with our products.</p>
    </div>
    <div class="footer-icons">
        <img src="../img/facebookIcon.png" class="icons">
        <img src="../img/twitterIcon.png" class="icons">
    </div>
</footer>

<script>

    const hamburger = document.getElementById('hamburger');
    const navLinks = document.getElementById('navbar');

    hamburger.addEventListener('click', () => {
        navLinks.classList.toggle('show');
        hamburger.classList.toggle('active');
    });


    let cart = [];  // Array to store cart items
    const cartItemsDiv = document.getElementById('cart-items');
    const totalAmountSpan = document.getElementById('total-amount');

    // Fetch cart items from the backend
    async function fetchCartItems() {
        try {
            const response = await fetch('../api/cart');
            if (!response.ok) throw new Error('Failed to fetch cart items');

            const items = await response.json();
            cart = items;  // Store items in the cart array
            renderCartItems();  // Render items on the page

            // Set up event listener for payment button here
            document.querySelector('.pay-button').addEventListener('click', proceedToPay);
        } catch (error) {
            console.error('Error fetching cart items:', error);
            alert('There was a problem loading your cart. Please try again.');
        }
    }

    // Render cart items dynamically
    function renderCartItems() {
        cartItemsDiv.innerHTML = '';  // Clear the existing cart items

        let totalAmount = 0;
        cart.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'p-2', 'bg-white', 'mt-4', 'rounded');

            itemElement.innerHTML = `
                <div><img class="rounded" src="img/${item.image}" width="70"></div>
                <div>${item.name}</div>
                <div class="d-flex align-items-center qty-controls">
                    <button class="btn btn-sm btn-danger" onclick="updateQuantity('${item._id}', ${item.quantity - 1})">-</button>
                    <span class="mx-2">${item.quantity}</span>
                    <button class="btn btn-sm btn-success" onclick="updateQuantity('${item._id}', ${item.quantity + 1})">+</button>
                </div>
                <div>$${item.price * item.quantity}</div>
                <button class="btn btn-danger btn-sm" onclick="removeItem('${item._id}')"><i class="fa fa-trash"></i></button>
            `;

            cartItemsDiv.appendChild(itemElement);
            totalAmount += item.price * item.quantity;  // Update total amount
        });

        totalAmountSpan.textContent = `$${totalAmount.toFixed(2)}`;
    }

    // Update item quantity in the cart
    async function updateQuantity(itemId, newQuantity) {
        if (newQuantity <= 0) return;  // Prevent quantity from going below 1

        await fetch(`../api/cart/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity: newQuantity })
        });

        // Re-fetch the updated cart items
        fetchCartItems();
    }

    // Remove item from the cart
    async function removeItem(itemId) {
        await fetch(`../api/cart/${itemId}`, {
            method: 'DELETE'
        });

        // Re-fetch the updated cart items
        fetchCartItems();
    }

    // Proceed to payment
    async function proceedToPay() {
        const response = await fetch('../api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cart, total: calculateTotalAmount() })
        });
        const { clientSecret } = await response.json();

        const stripe = Stripe('your-stripe-public-key');  // Use your Stripe public key
        const { error } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: {
                    // Collect card details (you'll need an element on the page for this)
                },
                billing_details: {
                    // Customer details here
                }
            }
        });

        if (error) {
            console.error('Payment failed:', error);
        } else {
            alert('Payment successful!');
            // Optionally, clear the cart
        }
    }

    // Calculate the total amount in the cart
    function calculateTotalAmount() {
        return cart.reduce((total, item) => total + item.price * item.quantity, 0);
    }

    // Fetch and display cart items on page load
    window.onload = fetchCartItems;
</script>

</body>
</html>
